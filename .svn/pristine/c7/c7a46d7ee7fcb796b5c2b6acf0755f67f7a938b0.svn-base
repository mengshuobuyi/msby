//
//  PharmacyStoreDetailViewController.m
//  APP
//  非微商城市普通药房详情页面
//  Created by Meng on 15/6/2.
//  Copyright (c) 2015年 carret. All rights reserved.
//

#import "PharmacyStoreDetailViewController.h"
#import "WebDirectViewController.h"
//table cell
#import "AddressCell.h"
#import "StoreCommentCell.h"
#import "RegionBestSellerCell.h"
#import "LookMoreTableViewCell.h"
#import "PharmacyCommentDetailTableViewCell.h"
#import "ConsultCouponTableViewCell.h"

//category
#import "UIView+LoadFromNib.h"

//view
#import "XLCycleScrollView.h"
#import "StoreDetailHeadView.h"

//api //model
#import "Coupon.h"
#import "Store.h"
#import "StoreModel.h"
#import "StoreModelR.h"

#import "Appraise.h"
#import "AppraiseModel.h"
#import "AppraiseModelR.h"

#import "Activity.h"
#import "ActivityModel.h"
#import "ActivityModelR.h"

#import "Drug.h"
#import "DrugModel.h"
#import "DrugModelR.h"

#import "Favorite.h"
#import "FavoriteModel.h"
#import "FavoriteModelR.h"

//other
#import "SVProgressHUD.h"
#import "SBJson.h"
#import "ReturnIndexView.h"
#import "AutoScrollView.h"

//controllers
//#import "CouponDeatilViewController.h"
#import "MarketDetailViewController.h"
#import "PharmacyStoreMapViewController.h"
#import "LoginViewController.h"
#import "EvaluationViewController.h"
#import "ActivityListViewController.h"
#import "MarketDetailViewController.h"
#import "PhrmacyMoreDrugsViewController.h"
#import "MessageBoxListViewController.h"
#import "ReportDrugStoreViewController.h"
#import "ChatViewController.h"
#import "CouponDrugListViewController.h"
#import "CouponPharmacyDeailViewController.h"
#import "CenterCouponDetailViewController.h"
#import "MutableMorePromotionTableViewCell.h"
#import "PromotionActivityDetailViewController.h"
#import "RCDraggableButton.h"


//define
#define EmptyArguementListPlaceholder       @"暂无评价"
#define EmptyActivityListPlaceholder        @"暂无活动,敬请期待!"
#define EmptyWellSellListPlaceholder        @"暂无畅销商品"

#define kSectionHeaderSpaceHeight      7
#define kSectionFooterHeight           30
#define kEmptyHeight                   45
#define kNormalHeight                  45

//刷新动画
#define kTableViewRowAnimation              UITableViewRowAnimationFade

static NSString * const AddressCellIdentifier                       = @"AddressCellIdentifier";
static NSString * const StoreCommentCellIdentifier                  = @"ConsultPharmacyDetailIdentifier";
static NSString * const ActivityScrollCellIdentifier                = @"ActivityScrollCellIdentifier";//优惠活动
static NSString * const MarketActivityCellIdentifier                = @"MarketActivityCellIdentifier";//营销活动
static NSString * const RegionBestSellerTableCellIdentifier         = @"RegionBestSellerTableCellIdentifier";//区域畅销商品tableCell
static NSString * const RegionBestSellerCollectViewCellIdentifier   = @"RegionBestSellerCollectViewCellIdentifier";//collectViewCell
static NSString * const EmptyCellIdentifier                         = @"EmptyCellIdentifier";//空cell
static NSString * const MoreCellIdentifier                          = @"MoreCellIdentifier";

@interface PharmacyStoreDetailViewController()<UITableViewDataSource,UITableViewDelegate,XLCycleScrollViewDatasource,XLCycleScrollViewDelegate,UICollectionViewDataSource,UICollectionViewDelegate,UIAlertViewDelegate,ConsultCouponTableViewCellDelegate,AutoScrollViewDelegate>
{
    XLCycleScrollView *cycleScrollView;
    UIView *bkView;
    AutoScrollView *autoScrollView;
}
@property (nonatomic ,strong) StoreDetailHeadView *storeHeadView;//顶部view

@property (weak, nonatomic) IBOutlet UIView *noNetWorkView;
- (IBAction)bgViewButtonClick:(UIButton *)sender;

@property (weak, nonatomic) IBOutlet UITableView *bgTableView;

@property (nonatomic ,strong) NSMutableArray *arguementList;//评论
@property (nonatomic ,strong) NSMutableArray *activityList;//活动词汇（跑马灯）
@property (nonatomic ,strong) NSMutableArray *couponQuanList;//优惠券
@property (nonatomic ,strong) NSMutableArray *couponDrugList;//优惠商品

@property (nonatomic ,strong) NSMutableArray *promotionList;
@property (nonatomic ,strong) NSMutableArray *sellWellDrugList;

@property (strong, nonatomic) ReturnIndexView *indexView;

@property (nonatomic, strong) UILabel *numLabel;   //数字角标
@property (nonatomic, strong) UILabel *redLabel;   //小红点
@property (nonatomic, strong) NSMutableArray *arrExpand;
@property (assign, nonatomic) int passNumber;


@end

@implementation PharmacyStoreDetailViewController

- (instancetype)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    if (self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil]) {
        [self initObjs];
    }
    return self;
}

- (instancetype)init
{
    if (self =[super init]) {
        [self initObjs];
    }
    return self;
}

- (void)initObjs
{
    self.arguementList = [NSMutableArray array];
    self.activityList = [NSMutableArray array];
    self.promotionList = [NSMutableArray array];
    self.sellWellDrugList = [NSMutableArray array];
    self.arrExpand = [[NSMutableArray alloc] init];
}

- (void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:animated];
    [cycleScrollView stopAutoScroll];
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    self.passNumber = [QWGLOBALMANAGER updateRedPoint];
    [self setUpRightItem];
    [self getCouponQuan];
    [self checkIfCollected];
    if (self.promotionList.count > 0) {
        [cycleScrollView startAutoScroll:5];
    }
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    self.title = @"药房详情";
    [self.bgTableView registerNib:[UINib nibWithNibName:@"PharmacyCommentDetailTableViewCell" bundle:nil] forCellReuseIdentifier:StoreCommentCellIdentifier];
    [self.bgTableView registerNib:[UINib nibWithNibName:@"LookMoreTableViewCell" bundle:nil] forCellReuseIdentifier:MoreCellIdentifier];
    [self.bgTableView registerClass:[UITableViewCell class] forCellReuseIdentifier:MarketActivityCellIdentifier];
    [self.bgTableView registerClass:[UITableViewCell class]     forCellReuseIdentifier:EmptyCellIdentifier];
    self.bgTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
 
    _storeHeadView = [StoreDetailHeadView loadFromNib];
    [_storeHeadView.addressButton addTarget:self action:@selector(addressButtonClick) forControlEvents:UIControlEventTouchUpInside];
    
    
    [_storeHeadView setFrame:CGRectMake(0, 0, APP_W, 235.0f)];
    self.bgTableView.tableHeaderView = _storeHeadView;
    self.bgTableView.backgroundColor = RGBHex(qwColor11);
    [self.bgTableView addStaticImageHeader];
    
//        self.bgTableView.tableHeaderView = headerView;
    
        
    self.bgTableView.tableFooterView = [[UIView alloc] init];
    
        
    [self loadAllDataAsynchronous];
    [QWGLOBALMANAGER readLocationWhetherReLocation:NO block:^(MapInfoModel *mapInfoModel) {
        
        NSString *cityEnable;
        if(mapInfoModel.status == 3){
            cityEnable = @"开通";
        }else{
            cityEnable = @"未开通";
        }
        if(StrIsEmpty(self.lastPageName)){
            self.lastPageName = @"未知";
        }
        [QWGLOBALMANAGER statisticsEventId:@"x_yfxq_xq" withLable:@"药房详情" withParams:[NSMutableDictionary dictionaryWithDictionary:@{@"药房名":self.title,@"是否开通微商":cityEnable,@"上级页面":self.lastPageName}]];
    }];
    
    
}

#pragma mark - 请求药房基本数据和跑马灯、优惠券、优惠商品、评价数据
- (void)loadAllDataAsynchronous
{
    if (QWGLOBALMANAGER.currentNetWork == kNotReachable) {
        self.noNetWorkView.hidden = NO;
        return;
    }else{
        self.noNetWorkView.hidden = YES;
    }
    
    [QWLOADING showLoading];


        
        //HTTP请求
        [self checkIfCollected];
        [self queryStoreSearch];
        [self checkArguementList];
        [self checkActivityList];
//        [self getCouponQuan];
        [self getCouponDrug];
        
//        [self getStoreBranchPromotion];
//        [self getSellWellProductsList];

    
    
}

#pragma mark - Request药房基本信息
- (void)queryStoreSearch
{
    
    StoreSearchModelR *searchModelR = [StoreSearchModelR new];
    searchModelR.groupId = self.storeId;
    
    [Store storeSearchWithParams:searchModelR success:^(id resultObj) {
        
        if(resultObj)
        {
            self.storeModel = (StoreNearByModel *)resultObj;
            if([self.storeModel.apiStatus intValue]==1&&self.bannerStatus==1){
           
                    [UIView animateWithDuration:0.3 animations:^{
                        bkView.alpha = 0;
                    } completion:^(BOOL finished) {
                        [bkView removeFromSuperview];
                        [self showInfoView:@"暂无数据" image:@"ic_img_fail"];
                        [QWLOADING removeLoading];
                        
                    }];
          
                return;
            }
            
            _storeHeadView.titleLabel.text = self.storeModel.name;
            if ([self.storeModel.isStar isEqualToString:@"Y"]) {
                _storeHeadView.VImage.hidden = NO;
            }else{
                _storeHeadView.VImage.hidden = YES;
            }
            
            _storeHeadView.locationLabel.text = [NSString stringWithFormat:@"%@%@%@%@",self.storeModel.province,self.storeModel.city,self.storeModel.county,self.storeModel.addr];

            
            if(StrIsEmpty(self.storeModel.tel)){
                [_storeHeadView.phoneImage setImage:[UIImage imageNamed:@"btn_img_phonegray"]];
            }else{
                [_storeHeadView.phoneImage setImage:[UIImage imageNamed:@"btn_img_phone"]];
                [_storeHeadView.callButton addTarget:self action:@selector(callWithConsult:) forControlEvents:UIControlEventTouchUpInside];
            }
            [_storeHeadView.chatBtn addTarget:self action:@selector(chatWithConsult:) forControlEvents:UIControlEventTouchUpInside];
            
            //active字段判断是否可以聊天，-1:表示不能聊天
            if ([self.storeModel.active integerValue] == -1) {//未开通
                _storeHeadView.chatImageView.image = [UIImage imageNamed:@"btn_img_advisorygray"];
            }else{//已开通
                _storeHeadView.chatImageView.image = [UIImage imageNamed:@"btn_img_advisory_nearby"];
                
                [_storeHeadView.collectButton addTarget:self action:@selector(collectTapClick) forControlEvents:UIControlEventTouchUpInside];
                
                [self refreshTagView];
            }
            [self refreshStarView];
            self.bgTableView.tableHeaderView = _storeHeadView;
            [self.bgTableView reloadData];
        }
    } failure:^(HttpException *e) {
        [SVProgressHUD showErrorWithStatus:e.Edescription duration:0.8];
    }];
  
}

#pragma mark - 进入聊天室方法
- (void)chatWithConsult:(id)sender{//进入聊天室方法
    
    if([self.storeModel.active integerValue] == -1){//未开通
        
        [SVProgressHUD showErrorWithStatus:@"暂未开通咨询功能"];

    }else{//已开通
        if(!QWGLOBALMANAGER.loginStatus) {
            LoginViewController *loginViewController = [[LoginViewController alloc] initWithNibName:@"LoginViewController" bundle:nil];
            [self.navigationController pushViewController:loginViewController animated:YES];
            return;
        }
        [QWGLOBALMANAGER statisticsEventId:@"x_yfxq_zxzx" withLable:@"药房详情-在线咨询" withParams:nil];
        ChatViewController *consultViewController = [[UIStoryboard storyboardWithName:@"ChatViewController" bundle:[NSBundle mainBundle]] instantiateViewControllerWithIdentifier:@"ChatViewController"];
        consultViewController.sendConsultType = Enum_SendConsult_Common;
        consultViewController.branchId = self.storeId;
        if(StrIsEmpty(self.storeModel.shortName)){
            consultViewController.branchName = self.storeModel.name;
        }else{
            consultViewController.branchName = self.storeModel.shortName;
        }
        
        [self.navigationController pushViewController:consultViewController animated:YES];
    }
}
#pragma mark - 打电话方法
- (void)callWithConsult:(id)sender{//打电话方法
    if(StrIsEmpty(self.storeModel.tel)){
        
    }else{
        NSString *tel = self.storeModel.tel;
        if (!StrIsEmpty(tel)) {
            UIAlertView *alert = [[UIAlertView alloc]initWithTitle:self.storeModel.tel message: nil delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"呼叫", nil];
            [alert show];
        }
    }
}

#pragma mark - Request是否被收藏
- (void)checkIfCollected
{
    if (QWGLOBALMANAGER.loginStatus == NO) {
        return;
    }
    FavoriteCollectR *collectR=[FavoriteCollectR new];
    collectR.token=QWGLOBALMANAGER.configure.userToken;
    collectR.objId=self.storeId;
    collectR.objType=@"7";
    collectR.method=@"1";
    
    [Favorite collectWithParam:collectR success:^(id resultObj) {
        CancleResult *resultModel=(CancleResult *)resultObj;
        
        if ([resultModel.result isEqualToString:@"1"]){
            
            [_storeHeadView.collectButton setImage:[UIImage imageNamed:@"btn_img_select"] forState:UIControlStateNormal];
            
        }else if([resultModel.result isEqualToString:@"0"]){
            [_storeHeadView.collectButton setImage:[UIImage imageNamed:@"btn_img_nomal"] forState:UIControlStateNormal];
        }
        
    } failure:^(HttpException *e) {
        
    }];
}

#pragma mark - Request评价
- (void)checkArguementList
{
    StoreAppraiseModelR *appraiseModelR = [StoreAppraiseModelR new];
    appraiseModelR.branchId = self.storeId;
    appraiseModelR.page = @1;
    appraiseModelR.pageSize = @10;
    
    
    [Appraise queryAppraiseWithParams:appraiseModelR success:^(id resultObj) {
        
        QueryAppraiseModel*queryModel = (QueryAppraiseModel *)resultObj;
//        NSMutableArray *arr = [NSMutableArray arrayWithArray:queryModel.list];
//        for (int i=0; i<arr.count; i++) {
//            StoreAppraiseModel *model = arr[i];
//            if (StrIsEmpty(model.remark)) {
//                [arr removeObject:model];
//            }
//        }
        [self.arguementList removeAllObjects];
        [self.arguementList addObjectsFromArray:queryModel.appraises];
        for (int i = 0; i<self.arguementList.count; i++) {
            NSMutableDictionary *dicExpand = [@{@"expand":@NO} mutableCopy];
            [self.arrExpand addObject:dicExpand];
        }
        NSIndexSet *indexSet = [NSIndexSet indexSetWithIndex:1];

            [self.bgTableView reloadData];
            [UIView animateWithDuration:0.3 animations:^{
                bkView.alpha = 0;
            } completion:^(BOOL finished) {
                [bkView removeFromSuperview];
                [QWLOADING removeLoading];
                
            }];
        
  
        
    } failure:^(HttpException *e) {
        
    }];
}

#pragma mark - Request药房活动跑马灯
- (void)checkActivityList
{
    //使用StoreAppraiseModelR model,字段一致
    BranchActivityModelR *activityModelR = [BranchActivityModelR new];
    activityModelR.branchId = self.storeId;

    
    [Store queryBranchActivitiesWithParams:activityModelR success:^(id resultObj) {
        
        BranchActivityModel *model = (BranchActivityModel *)resultObj;
        self.activityList  = [NSMutableArray arrayWithArray:model.list];
        [self.bgTableView reloadData];
        
    } failure:^(HttpException *e) {
        
    
    }];
}

#pragma mark - Request优惠Banner轮播
- (void)getStoreBranchPromotion
{
    GetBranchPromotionR *getBranchPromotionR = [GetBranchPromotionR new];
    getBranchPromotionR.branchId = self.storeId;
    getBranchPromotionR.currPage = @1;
    getBranchPromotionR.pageSize = @4;
    [Activity getStoreBranchPromotion:getBranchPromotionR success:^(id resultObj) {
        BranchPromotionListModel *listModel = (BranchPromotionListModel *)resultObj;
        [self.promotionList removeAllObjects];
        [self.promotionList addObjectsFromArray:listModel.list];
//        [self.bgTableView reloadSections:[NSIndexSet indexSetWithIndex:2] withRowAnimation:kTableViewRowAnimation];
        
    } failure:^(HttpException *e) {
        
    }];
}

#pragma mark - Request优惠券
- (void)getCouponQuan{
    
    pharmacyCouponModelR *modelR = [pharmacyCouponModelR new];
    modelR.branchId = self.storeId;
    modelR.currPage = @1;
    modelR.pageSize = @100;
    if(QWGLOBALMANAGER.loginStatus){
        modelR.token = QWGLOBALMANAGER.configure.userToken;
    }
    [Coupon pharmacyCouponQuan:modelR success:^(id obj) {
        
        pharmacyCouponQuanList *quan = (pharmacyCouponQuanList *)obj;
        self.couponQuanList = [NSMutableArray arrayWithArray:quan.list];
        [self.bgTableView reloadData];
        
    } failure:^(HttpException *e) {
        
        [SVProgressHUD showErrorWithStatus:e.Edescription duration:0.5];
    }];
}

#pragma mark - Request优惠商品
- (void)getCouponDrug{
    
    pharmacyProductModelR *modelR = [pharmacyProductModelR new];
    modelR.branchId = self.storeId;
    modelR.currPage = @1;
    modelR.pageSize = @10;
    
    [Coupon pharmacyCouponDrugNew:modelR success:^(id obj) {
        
        BranchPromotionProListVo *quan = (BranchPromotionProListVo *)obj;
        self.couponDrugList = [NSMutableArray arrayWithArray:quan.pros];
        [self.bgTableView reloadData];
        
    } failure:^(HttpException *e) {
        
        [SVProgressHUD showErrorWithStatus:e.Edescription duration:0.5];
    }];
}


#pragma mark - Request区域畅销商品 2.2.0未用
- (void)getSellWellProductsList
{
    SellWellProductsR *sellWellR = [SellWellProductsR new];
    //sellWellR.groupId = self.storeId;
    sellWellR.currPage = @1;
    sellWellR.pageSize = @3;
    
    
    [Drug drugSellListWithParam:sellWellR Success:^(id DFModel) {
        
        DrugSellWellProductsModel *productsModel = (DrugSellWellProductsModel *)DFModel;
        [self.sellWellDrugList removeAllObjects];
        [self.sellWellDrugList addObjectsFromArray:productsModel.list];
        
//        [self.bgTableView reloadSections:[NSIndexSet indexSetWithIndex:4] withRowAnimation:kTableViewRowAnimation];
        
    } failure:^(HttpException *e) {
   
            [self.bgTableView reloadData];
            [UIView animateWithDuration:0.3 animations:^{
                bkView.alpha = 0;
            } completion:^(BOOL finished) {
                [bkView removeFromSuperview];
                [QWLOADING removeLoading];
                
            }];
    
    }];
}



#pragma mark - 刷新评价星星
- (void)refreshStarView
{
    [_storeHeadView.starView setImagesDeselected:@"star_none.png"
                                  partlySelected:@"star_half.png"
                                    fullSelected:@"star_full"
                                     andDelegate:nil];
//    CGFloat rating = [self.storeModel.star floatValue];
//    float avgStar = [self.storeModel.avgStar floatValue];
//    rating = MAX(rating, avgStar);
    [_storeHeadView.starView displayRating:[self.storeModel.mshopStar floatValue] / 2];
}


#pragma mark - 刷新Tag
- (void)refreshTagView
{
//    id tags = self.storeModel.tags;
//    if([tags isKindOfClass:[NSString class]]){
//        tags = [tags JSONValue];
//    }
//    
//    if (![tags isKindOfClass: [NSNull class]]) {
//        [_storeHeadView layoutTagsWith:tags];
//    }
    
    [_storeHeadView UITags:self.storeModel.tags];
}

#pragma mark - TableViewDelegate
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return 3;
}

//HeaderInSection
- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    switch (section) {
     
        case 0:{
            if(self.activityList.count == 0){
                return 0.0;
            }else{
                return 41 + kSectionHeaderSpaceHeight;
            }
        }
            break;
        case 1:{
            if(self.couponDrugList.count == 0){
                return 0;
            }else{
                return 38;
            }
        }
            break;
        case 2:{
            if(self.couponDrugList.count == 0){
                return 38;
            }else{
                return 38 + kSectionHeaderSpaceHeight;
            }
            return 38 + kSectionHeaderSpaceHeight;
        }
            break;
            
        default:
            return kSectionHeaderSpaceHeight;
            break;
    }
}

//去掉UItableview headerview黏性(sticky)
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    CGFloat sectionHeaderHeight = 40;
    if (scrollView.contentOffset.y<=sectionHeaderHeight&&scrollView.contentOffset.y>=0) {
        scrollView.contentInset = UIEdgeInsetsMake(-scrollView.contentOffset.y, 0, 0, 0);
    } else if (scrollView.contentOffset.y>=sectionHeaderHeight) {
        scrollView.contentInset = UIEdgeInsetsMake(-sectionHeaderHeight, 0, 0, 0);
    }
}


- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    CGFloat height = 0;
    NSString *title;
    switch (section) {
        case 0:
        {
            height = 41 + kSectionHeaderSpaceHeight;
        }
            break;
        case 1:
        {
            height = 38;
            title = @"优惠商品";
        }
            break;
        case 2:
        {
            if(self.couponDrugList.count == 0){
                height = 38;
            }else{
                height = 38 + kSectionHeaderSpaceHeight;
            }
            title = @"评价";
        }
            break;
        default:
            break;
    }
    UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, 0, APP_W, height)];
    view.backgroundColor = [UIColor whiteColor];
    UIView *spaceView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, APP_W, kSectionHeaderSpaceHeight)];
    spaceView.backgroundColor = RGBHex(qwColor11);
    
    if(section != 2){
        [view addSubview:spaceView];
    }
    if (view.frame.size.height > 0) {
        UILabel * label = [[UILabel alloc] initWithFrame:CGRectMake(15, kSectionHeaderSpaceHeight + (height - kSectionHeaderSpaceHeight - 21)/2, APP_W-24, 21)];
        label.text = title;
        label.textColor = RGBHex(qwColor8);
        label.font = fontSystem(kFontS4);
        
        if(section == 2){
            
            if(self.couponDrugList.count > 0){
                UIView *seperator = [[UIView alloc]initWithFrame:CGRectMake(0, 0, APP_W, kSectionHeaderSpaceHeight)];
                seperator.backgroundColor = RGBHex(qwColor11);
                [view addSubview:seperator];
            }
            UIView *line = [[UIView alloc]initWithFrame:CGRectMake(0, height + kSectionHeaderSpaceHeight - 0.5, APP_W, 0.5)];
            line.backgroundColor = RGBHex(qwColor10);
            [view addSubview:line];
        }
        
        if(section == 1){
            
            
            label.textColor = RGBHex(qwColor8);
            label.frame = CGRectMake(12, (height - kSectionHeaderSpaceHeight - 21)/2, APP_W-24, 21);
            label.font = fontSystem(14.0f);
            spaceView.frame = CGRectMake(0, height - kSectionHeaderSpaceHeight, APP_W, kSectionHeaderSpaceHeight);

//            UIImage *image = [UIImage imageNamed:@"arr_right"];
//            UIImageView *rightImage = [[UIImageView alloc]initWithImage:image];
//            rightImage.frame = CGRectMake(APP_W - 12, (height - kSectionHeaderSpaceHeight - image.size.height)/2, image.size.width, image.size.height);
//            [view addSubview:rightImage];
            

        }
        
        label.font = fontSystem(15);
        [view addSubview:label];
        
        if(section == 0){
            [label removeFromSuperview];
            if(self.activityList.count == 0){
                return nil;
            }
            
            UIImageView *noticeImageView = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"ic_bulletin_img_notice"]];
            noticeImageView.frame = CGRectMake(15, (height + kSectionHeaderSpaceHeight - 16)/2, 16, 16);
            [view addSubview:noticeImageView];
            
            autoScrollView = nil;
            if(self.activityList && self.activityList.count > 0){
                autoScrollView = [[AutoScrollView alloc]initWithFrame:CGRectMake(noticeImageView.frame.origin.x + noticeImageView.frame.size.width + 15, 10, APP_W - 66, 35)];
//                autoScrollView.backgroundColor = [UIColor grayColor];
                autoScrollView.dataArray = self.activityList;
                autoScrollView.delegate = self;
                [view addSubview:autoScrollView];
                [autoScrollView setupView];
            }
            UIImage *image = [UIImage imageNamed:@"arr_right"];
            UIImageView *rightImage = [[UIImageView alloc]initWithImage:image];
            rightImage.frame = CGRectMake(APP_W - 12, kSectionHeaderSpaceHeight + (height - kSectionHeaderSpaceHeight - image.size.height)/2, image.size.width, image.size.height);
            [view addSubview:rightImage];
            spaceView.frame = CGRectMake(0, 0, APP_W, kSectionHeaderSpaceHeight);
        }
    }
    return view;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    switch (section) {
        case 0:{//优惠券
            if(self.couponQuanList.count > 0){
                return 1;
            }else{
                return 0;
            }
        }
            break;
        case 1:{//优惠商品
            
            if(self.couponDrugList.count > 4){
                return 5;
            }else if(self.couponDrugList.count > 0){
                    return self.couponDrugList.count;
            }else{
                return 0;
            }
        }
            break;
        case 2:{//用户评价
            if (self.arguementList.count > 2) {
                return 3;
            }else if (self.arguementList.count == 2){
                return 2;
            }else{
                return 1;
            }
        }
            break;
        default:
            return 0;
            break;
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    switch (indexPath.section) {
        case 0://优惠券ScrollView
            return 77.0f;
            break;
            
        case 1://优惠商品
            if(indexPath.row == 4){
                return 40.0f;
            }else{
                return [MutableMorePromotionTableViewCell getCellHeight:self.couponDrugList[indexPath.row]];
            }
            break;
        case 2://用户评价
        {
            if (self.arguementList.count > 0) {
//                StoreAppraiseModel *appraiseModel = self.arguementList[indexPath.row];
//                CGFloat offset = [self calculateCollapseHeigtOffsetWithFontSize:[UIFont systemFontOfSize:14.0] withTextSting:appraiseModel.remark withRowAtIndexPath:indexPath];
//                CGFloat rowHeight = 0.0f;
//                if ([self shouldAddExpandView:indexPath withFont:[UIFont systemFontOfSize:14.0]]) {
//                    rowHeight = 80+offset;
//                } else {
//                    rowHeight = 55+offset;
//                }
//                if (indexPath.row == 2) {
//                    return kNormalHeight;
//                }
//                return rowHeight;
                return 71.0f;
            }else{
                return kEmptyHeight;
            }
        }
            break;
        
        default:
            return 0;
            break;
    }
}

-(void)expandCell:(NSIndexPath *)selectCellIndex{
    
    BranchPromotionProVO *vo = self.couponDrugList[selectCellIndex.row];
    
    if(vo.isSelect){
        vo.isSelect=NO;
    }else{
        vo.isSelect=YES;
    }
    
    [self.bgTableView reloadData];
    
}


//cell的收缩高度
- (CGFloat)calculateCollapseHeigtOffsetWithFontSize:(UIFont *)fontSize withTextSting:(NSString *)text withRowAtIndexPath:(NSIndexPath *)indexPath
{
    CGSize adjustSize = [text sizeWithFont:fontSize constrainedToSize:CGSizeMake(294, 1000) lineBreakMode:NSLineBreakByWordWrapping];
    if(adjustSize.height > 50.0f)
    {
        NSMutableDictionary *dicExpand = self.arrExpand[indexPath.row];
        if ([dicExpand[@"expand"] boolValue]) {
            return adjustSize.height;
        } else {
            return 50.0f;
        }
    }else{
        return adjustSize.height;//0;
    }
}

- (BOOL)shouldAddExpandView:(NSIndexPath *)indexPath withFont:(UIFont *)fontSize
{
    StoreAppraiseModel *appraiseModel = self.arguementList[indexPath.row];
    CGSize adjustSize = [appraiseModel.remark sizeWithFont:fontSize constrainedToSize:CGSizeMake(294, 1000) lineBreakMode:NSLineBreakByWordWrapping];
    if (adjustSize.height > 50.0f) {
        return YES;
    } else {
        return NO;
    }
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    switch (indexPath.section) {
        //打折领券
        case 0:
        {
            NSString *ConsultPharmacyIdentifier = @"ConsultCouponTableViewCell";
            ConsultCouponTableViewCell *cell = (ConsultCouponTableViewCell *)[tableView dequeueReusableCellWithIdentifier:ConsultPharmacyIdentifier];
            if(cell == nil){
                UINib *nib = [UINib nibWithNibName:@"ConsultCouponTableViewCell" bundle:nil];
                [tableView registerNib:nib forCellReuseIdentifier:ConsultPharmacyIdentifier];
                cell = (ConsultCouponTableViewCell *)[tableView dequeueReusableCellWithIdentifier:ConsultPharmacyIdentifier];
                
            }
            cell.delegate = self;
            [cell setScrollView:self.couponQuanList];
            return cell;
            
        }
            break;
        //优惠商品
        case 1:
        {
            if (indexPath.row == 4) {
                LookMoreTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:MoreCellIdentifier forIndexPath:indexPath];
                cell.selectedBackgroundView = [[UIView alloc]init];
                cell.selectedBackgroundView.backgroundColor = RGBHex(qwColor10);
                cell.titleLabel.font = fontSystem(14.0f);
                cell.titleLabel.textColor = RGBHex(qwColor8);
                cell.titleLabel.text = @"查看更多";
        
                return cell;
            }else{
                
                MutableMorePromotionTableViewCell *cell = (MutableMorePromotionTableViewCell *)[tableView cellForRowAtIndexPath:indexPath];
                if (!cell) {
                    NSArray* nib = [[NSBundle mainBundle] loadNibNamed:@"MutableMorePromotionTableViewCell" owner:self options:nil];
                    cell = [nib objectAtIndex:0];
                }
                ChannelProductVo *vo = self.couponDrugList[indexPath.row];
                cell.selectedCell=indexPath;
                [cell setupCell:vo];
                return cell;      
            }

        }
            break;
        //评价
        case 2:
        {
            if (self.arguementList.count > 0) {
                if (indexPath.row ==2) {
                    LookMoreTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:MoreCellIdentifier forIndexPath:indexPath];
                    cell.selectedBackgroundView = [[UIView alloc]init];
                    cell.selectedBackgroundView.backgroundColor = RGBHex(qwColor10);
                    cell.titleLabel.text = @"查看更多";
                    return cell;
                }else{
                    PharmacyCommentDetailTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:StoreCommentCellIdentifier forIndexPath:indexPath];
                    [self makeEvaluationCell:cell andIndexPath:indexPath];
                    return cell;
                }
            }else{
                UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:EmptyCellIdentifier forIndexPath:indexPath];
                cell.textLabel.text = EmptyArguementListPlaceholder;
                cell.selectionStyle = UITableViewCellSelectionStyleNone;
                cell.textLabel.font = fontSystem(14);
                cell.textLabel.textColor = RGBHex(qwColor7);
                cell.textLabel.textAlignment = NSTextAlignmentCenter;
                UIView *line = [[UIView alloc]initWithFrame:CGRectMake(0, cell.frame.size.height - 0.5, APP_W, 0.5)];
                line.backgroundColor = RGBHex(qwColor10);
                [cell addSubview:line];
                
                return cell;
            }
        }
            break;
        
        default:
            return nil;
            break;
    }
}

- (void)makeAddressCell:(AddressCell *)cell{
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    //            NSString *addressStr = [NSString stringWithFormat:@"%@%@%@",[self checkStringIsEmpty:self.storeModel.province],[self checkStringIsEmpty:self.storeModel.city],[self checkStringIsEmpty:self.storeModel.addr]];
    NSString *addressStr = [NSString stringWithFormat:@"%@",[self checkStringIsEmpty:self.storeModel.addr]];
    
    if (StrIsEmpty(addressStr)) {
        addressStr = @"暂无地理位置信息";
    }else{
        [cell.addressButton removeTarget:self action:@selector(addressButtonClick) forControlEvents:UIControlEventTouchUpInside];
        [cell.addressButton addTarget:self action:@selector(addressButtonClick) forControlEvents:UIControlEventTouchUpInside];
    }
    cell.addressLabel.text = addressStr;
    if ([self.storeModel.active integerValue] == -1) {//未开通
        cell.consultButton.hidden = YES;
        cell.consultImageView.hidden = YES;
    }else{
        //咨询按钮
        [cell.consultButton removeTarget:self action:@selector(cosultButtonClick) forControlEvents:UIControlEventTouchUpInside];
        [cell.consultButton addTarget:self action:@selector(cosultButtonClick) forControlEvents:UIControlEventTouchUpInside];
    }
    //打电话按钮
    NSString *tel = self.storeModel.tel;
    if (StrIsEmpty(tel)) {
        
        [cell.phoneImageView setImage:[UIImage imageNamed:@"ic_btn_phone_disabled"]];
        
        [cell.phoneButton removeTarget:self action:@selector(phoneButtonClick) forControlEvents:UIControlEventTouchUpInside];
    }else{
        [cell.phoneImageView setImage:[UIImage imageNamed:@"ic_btn_phone_store"]];
        [cell.phoneButton addTarget:self action:@selector(phoneButtonClick) forControlEvents:UIControlEventTouchUpInside];
    }
}

- (void)makeEvaluationCell:(PharmacyCommentDetailTableViewCell *)cell andIndexPath:(NSIndexPath *)indexPath{
    [cell setSelectionStyle:UITableViewCellSelectionStyleNone];
    StoreAppraiseModel *appraiseModel = self.arguementList[indexPath.row];
    NSMutableDictionary *dicExpand = self.arrExpand[indexPath.row];
    NSString *strUserName = @"";
    if ([appraiseModel.nick length] > 0) {
        strUserName = appraiseModel.nick;
    }else{
        strUserName = appraiseModel.date;
    }
    cell.userName.text = strUserName;
    cell.commentContent.text = appraiseModel.remark;
    CGFloat offset = [self calculateCollapseHeigtOffsetWithFontSize:[UIFont systemFontOfSize:14.0] withTextSting:appraiseModel.remark withRowAtIndexPath:indexPath];
    CGRect rect = cell.commentContent.frame;
    rect.size.height = offset;//37 + offset;
    cell.commentContent.frame = rect;
    float star = [appraiseModel.stars floatValue] / 2;
    [cell.ratingView displayRating:star];
    [cell.viewExpand removeFromSuperview];
    CGFloat rowHeight = 0.0f;
    if ([self shouldAddExpandView:indexPath withFont:[UIFont systemFontOfSize:14.0]]) {
        rowHeight = 80+offset;
        cell.viewExpand.hidden = NO;
        if ([dicExpand[@"expand"] boolValue]) {
            cell.imgViewExpand.image = [UIImage imageNamed:@"UpAccessory"];
            [cell.btnExpand setTitle:@"收起" forState:UIControlStateNormal];
        } else {
            cell.imgViewExpand.image = [UIImage imageNamed:@"DownAccessory"];
            [cell.btnExpand setTitle:@"更多" forState:UIControlStateNormal];
        }
        cell.btnExpand.tag = indexPath.row;
        [cell.btnExpand addTarget:self action:@selector(btnPressedExpandClick:) forControlEvents:UIControlEventTouchUpInside];
        cell.viewExpand.frame = CGRectMake(cell.viewExpand.frame.origin.x,
                                           cell.commentContent.frame.origin.y + cell.commentContent.frame.size.height+5.0f,
                                           cell.viewExpand.frame.size.width,
                                           cell.viewExpand.frame.size.height);
        
    } else {
        rowHeight = 55+offset;
        cell.viewExpand.hidden = YES;
    }
    UIView *cellBottomLine = [[UIView alloc] initWithFrame:CGRectMake(12, cell.frame.size.height - 0.5, APP_W, 0.5)];
    cellBottomLine.backgroundColor = RGBHex(qwColor10);
    [cell.contentView addSubview:cellBottomLine];
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    if(indexPath.section == 1){
        if (indexPath.row == 4) {//优惠商品更多
            CouponDrugListViewController *drugListView = [[CouponDrugListViewController alloc]initWithNibName:@"CouponDrugListViewController" bundle:nil];
            drugListView.storeId = self.storeId;
            drugListView.drugList = self.couponDrugList;
            [self.navigationController pushViewController:drugListView animated:YES];
            
        }else{//商品详情页面跳转（h5）
             ChannelProductVo *drug = self.couponDrugList[indexPath.row];
            
            //进入详情
            if(!drug.multiPromotion)
            {
                ActivityCategoryVo *ov = drug.promotionList[0];
                WebDirectViewController *vcWebMedicine = [[UIStoryboard storyboardWithName:@"WebDirect" bundle:nil] instantiateViewControllerWithIdentifier:@"WebDirectViewController"];
                [[QWGlobalManager sharedInstance] readLocationWhetherReLocation:NO block:^(MapInfoModel *mapInfoModel) {
                    WebDrugDetailModel *modelDrug = [WebDrugDetailModel new];
                    modelDrug.modelMap = mapInfoModel;
                    modelDrug.proDrugID = drug.proId;
                    modelDrug.promotionID = ov.pid;
//                    modelDrug.showDrug = @"1";
                    WebDirectLocalModel *modelLocal = [WebDirectLocalModel new];
//                    modelLocal.title = @"药品详情";
                    modelLocal.modelDrug = modelDrug;
                    modelLocal.typeLocalWeb = WebPageToWebTypeMedicine;
                    [vcWebMedicine setWVWithLocalModel:modelLocal];
                    [self.navigationController pushViewController:vcWebMedicine animated:YES];
                }];
            }else{
                //跳转到新的活动列表
                PromotionActivityDetailViewController *drugDetail = [[PromotionActivityDetailViewController alloc]init];
                drugDetail.vo=drug;
                drugDetail.branchId=self.storeId;
                [self.navigationController pushViewController:drugDetail animated:YES];
            }
        }
    }
    if(indexPath.section == 2){
        if (indexPath.row == 2) {//评价更多
            EvaluationViewController *evaluationViewController = [[EvaluationViewController alloc] init];
            evaluationViewController.storeId = self.storeModel.id;
            evaluationViewController.showRatingView = YES;
            [self.navigationController pushViewController:evaluationViewController animated:YES];
        }
    }
}

- (void)btnPressedExpandClick:(id)sender
{
    UIButton *btn = (UIButton *)sender;
    NSMutableDictionary *dicExpand = self.arrExpand[btn.tag];
    if ([dicExpand[@"expand"] boolValue]) {
        [dicExpand setValue:@NO forKey:@"expand"];
    } else {
        [dicExpand setValue:@YES forKey:@"expand"];
    }
    [self.bgTableView reloadRowsAtIndexPaths:@[[NSIndexPath indexPathForRow:btn.tag inSection:1]] withRowAnimation:UITableViewRowAnimationAutomatic];
}

#pragma mark - 地理位置信息点击触发方法
- (void)addressButtonClick
{
    if (!StrIsEmpty(self.storeModel.latitude) && !StrIsEmpty(self.storeModel.longitude)) {
        
        PharmacyStoreMapViewController *pharmacyMapViewController = [[PharmacyStoreMapViewController alloc] init];
        pharmacyMapViewController.mapStoreModel = self.storeModel;
        [self.navigationController pushViewController:pharmacyMapViewController animated:YES];
    }
}

#pragma mark XLScrollViewDelegate
- (BOOL)showBottomScrollLabel
{
    return YES;
}

- (NSInteger)numberOfPages
{
    if (self.promotionList.count > 1) {
        cycleScrollView.pageControl.hidden = NO;
        cycleScrollView.scrollView.scrollEnabled = YES;
        [cycleScrollView startAutoScroll:5];
    }else{
        cycleScrollView.scrollView.scrollEnabled = NO;
        cycleScrollView.pageControl.hidden = YES;
        [cycleScrollView stopAutoScroll];
    }
    return  self.promotionList.count > 3 ? 3 : self.promotionList.count;
}
- (UIView *)pageAtIndex:(NSInteger)index
{
    
    UIView *bgView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, APP_W, 150)];
    
    BranchPromotionModel*promotionModel = self.promotionList[index];
    UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0,APP_W, 120)];
    [imageView setImageWithURL:[NSURL URLWithString:promotionModel.imgUrl] placeholderImage:[UIImage imageNamed:@"banner_no-picture.jpg"]];
    [bgView addSubview:imageView];
    
    UILabel *_bottomLabel = [[UILabel alloc] initWithFrame:CGRectMake(10, imageView.frame.origin.y + imageView.frame.size.height, APP_W-10, kNormalHeight-0.5)];
    _bottomLabel.text = promotionModel.title;
    _bottomLabel.font = fontSystem(14);
    _bottomLabel.textColor = RGBHex(qwColor6);
    [bgView addSubview:_bottomLabel];
    return bgView;
}

- (void)didClickPage:(XLCycleScrollView *)csView atIndex:(NSInteger)index
{
//    BranchPromotionModel*promotionModel = self.promotionList[index];
//    CouponDeatilViewController *vc = [[CouponDeatilViewController alloc]initWithNibName:@"CouponDeatilViewController" bundle:nil];
//    vc.commonPromotionId = promotionModel.id;//优惠活动的ID
//    [self.navigationController pushViewController:vc animated:YES];
}
#pragma mark UICollectViewDataSource
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    if (self.sellWellDrugList.count > 2) {
        return 2;
    }else{
        return self.sellWellDrugList.count;
    }
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath
{
    
    RegionBestSellerCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:RegionBestSellerCollectViewCellIdentifier forIndexPath:indexPath];
    DrugSellWellProductsFactoryModel *model = self.sellWellDrugList[indexPath.row];
//    NSString* imgurl = PORID_IMAGE(model.proId);
    [cell.headImageView setImageWithURL:[NSURL URLWithString:model.imgUrl]
                  placeholderImage:[UIImage imageNamed:@"药品默认图片.png"]];
    cell.titleLabel.text = model.proName;
    cell.storeDrugTag.hidden = NO;
    NSString *str = [NSString stringWithFormat:@"NO.%d.png",indexPath.row +1];
    cell.storeDrugTag.image = [UIImage imageNamed:str];
    if(StrIsEmpty(model.tag)){
        cell.functionLabel.hidden = YES;
    }else{
        cell.functionLabel.hidden = NO;
        cell.functionLabel.text = model.tag;
    }
    return cell;
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    DrugSellWellProductsFactoryModel *factoryModel = self.sellWellDrugList[indexPath.row];
    [self pushToDrugDetailWithDrugID:factoryModel.proId promotionId:@""];
}

- (void)pushToDrugDetailWithDrugID:(NSString *)drugId promotionId:(NSString *)promotionID{
    
    WebDirectViewController *vcWebMedicine = [[UIStoryboard storyboardWithName:@"WebDirect" bundle:nil] instantiateViewControllerWithIdentifier:@"WebDirectViewController"];
    MapInfoModel *modelMap = [QWUserDefault getObjectBy:APP_MAPINFOMODEL];
    WebDrugDetailModel *modelDrug = [WebDrugDetailModel new];
    modelDrug.modelMap = modelMap;
    modelDrug.proDrugID = drugId;
    modelDrug.promotionID = promotionID;
//    modelDrug.showDrug = @"1";
    WebDirectLocalModel *modelLocal = [WebDirectLocalModel new];
//    modelLocal.title = @"药品详情";
    modelLocal.modelDrug = modelDrug;
    modelLocal.typeLocalWeb = WebPageToWebTypeMedicine;
    [vcWebMedicine setWVWithLocalModel:modelLocal];
    [self.navigationController pushViewController:vcWebMedicine animated:YES];
}


//查看更多
- (void)lookMoreButtonClick:(UIButton *)button
{
    if(QWGLOBALMANAGER.currentNetWork == kNotReachable){
        [SVProgressHUD showErrorWithStatus:@"您的网络不太给力，请点击重试!！" duration:1.0f];
        return;
    }
    NSInteger tag = button.tag;
    switch (tag) {
        case 1://用户评价
        {
            
        }
            break;
        case 2://查看更多优惠
        {
            
        }
            break;
        case 3://查看更多活动
        {
            
        }
            break;
        case 4://产看更多区域畅销商品
        {
            
        }
            break;
        default:
            break;
    }
}


#pragma mark - 点击优惠券回调事件
- (void)didSelectedCouponView:(pharmacyCouponQuan *)obj{
    
    if([obj.over boolValue]){//已领完
        return;
    }
//    CouponTicketDetailViewController *vcDetail = [[UIStoryboard storyboardWithName:@"CouponTicket" bundle:nil] instantiateViewControllerWithIdentifier:@"CouponTicketDetailViewController"];
//    [vcDetail setupCouponTicketDetailWithCouponId:obj.couponId showSuitablePhar:NO];
//    vcDetail.isComefrom = @"2";
    CenterCouponDetailViewController *vcDetail =[[CenterCouponDetailViewController alloc] initWithNibName:@"CenterCouponDetailViewController" bundle:nil];
    vcDetail.couponId=obj.couponId;
    [self.navigationController pushViewController:vcDetail animated:YES];

}

#pragma mark
#pragma mark 各种按钮事件

#pragma mark - 分享
- (void)shareTapClick
{
    ShareContentModel *modelShare = [[ShareContentModel alloc] init];
    modelShare.typeShare = ShareTypePharmacy;
    modelShare.shareID = self.storeModel.id;
    modelShare.title = self.storeModel.name;
    if (self.storeModel.brandImgUrl.length > 0) {
        modelShare.imgURL = self.storeModel.brandImgUrl;
    } else {
        modelShare.imgURL = self.storeModel.imgUrl;
    }
    
    modelShare.content = self.storeModel.intro;
    ShareSaveLogModel *modelR = [ShareSaveLogModel new];
    MapInfoModel *mapInfoModel = [QWUserDefault getObjectBy:APP_MAPINFOMODEL];
    if(mapInfoModel) {
        modelR.city = mapInfoModel.city;
        modelR.province = mapInfoModel.province;
    }else{
        modelR.city = @"苏州市";
        modelR.province = @"江苏省";
    }
    modelR.shareObj = @"2";
    modelR.shareObjId = self.storeModel.id;
    modelShare.modelSavelog = modelR;

    [self popUpShareView:modelShare];

}

#pragma mark - 收藏按钮触发函数
- (void)collectTapClick
{
    if (!QWGLOBALMANAGER.loginStatus) {
        
    
        LoginViewController *loginViewController = [[LoginViewController alloc] initWithNibName:@"LoginViewController" bundle:nil];
        loginViewController.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:loginViewController animated:YES];
        return;
    }
    
    FavoriteCollectR *collectR=[FavoriteCollectR new];
    collectR.token=QWGLOBALMANAGER.configure.userToken;
    collectR.objId=self.storeId;
    collectR.objType=@"7";
    collectR.method=@"1";
    
    [Favorite collectWithParam:collectR success:^(id DFUserModel) {
        
        CancleResult *model=(CancleResult *)DFUserModel;
        
        if([model.result isEqualToString:@"1"]){//已经收藏
            
            collectR.method = @"3";//取消收藏
            [Favorite collectWithParam:collectR success:^(id DFUserModel) {
                CancleResult *subModel=(CancleResult *)DFUserModel;
                if ([subModel.result isEqualToString:@"4"]) {//取消收藏成功
                    [SVProgressHUD showSuccessWithStatus:@"已取消关注" duration:DURATION_SHORT];

                    [_storeHeadView.collectButton setImage:[UIImage imageNamed:@"btn_img_nomal"] forState:UIControlStateNormal];
                }else if ([subModel.result isEqualToString:@"5"]){//取消收藏失败
                    [SVProgressHUD showErrorWithStatus:subModel.apiMessage duration:DURATION_SHORT];
                }
                
            } failure:^(HttpException *e) {
                DebugLog(@"%@",e);
            }];
            
        }else if([model.result isEqualToString:@"0"]){//未收藏
            collectR.method = @"2";//收藏当前对象
            [Favorite collectWithParam:collectR success:^(id DFUserModel) {
                CancleResult *subModel=(CancleResult *)DFUserModel;
                if ([subModel.result isEqualToString:@"2"]) {//收藏当前对象成功
                    [SVProgressHUD showSuccessWithStatus:@"关注成功" duration:DURATION_SHORT];
        
                    [_storeHeadView.collectButton setImage:[UIImage imageNamed:@"btn_img_select"] forState:UIControlStateNormal];
                }else if ([subModel.result isEqualToString:@"3"]){//收藏当前对象失败
                    [SVProgressHUD showErrorWithStatus:subModel.apiMessage duration:DURATION_SHORT];
                }
                
            } failure:^(HttpException *e) {
                DebugLog(@"%@",e);
            }];
            
        }
        
        
    } failure:^(HttpException *e) {
        DebugLog(@"%@",e);
    }];
}

- (void)collectButtonWhenNotLogin
{
    FavoriteCollectR *collectR = [FavoriteCollectR new];
    collectR.token=QWGLOBALMANAGER.configure.userToken;
    collectR.objId=self.storeId;
    collectR.objType=@"7";
    collectR.method=@"1";
    [Favorite collectWithParam:collectR success:^(id DFUserModel) {
        
        CancleResult *model=(CancleResult *)DFUserModel;
        
        if([model.result isEqualToString:@"1"]){//已经收藏
   
            
        }else if([model.result isEqualToString:@"0"]){//未收藏
            collectR.method = @"2";//收藏当前对象
            [Favorite collectWithParam:collectR success:^(id DFUserModel) {
                CancleResult *subModel=(CancleResult *)DFUserModel;
                if ([subModel.result isEqualToString:@"2"]) {//收藏当前对象成功
                    [SVProgressHUD showSuccessWithStatus:@"关注成功" duration:DURATION_SHORT];
              
                    [_storeHeadView.collectButton setImage:[UIImage imageNamed:@"btn_img_select"] forState:UIControlStateNormal];
                }else if ([subModel.result isEqualToString:@"3"]){//收藏当前对象失败
                    [SVProgressHUD showErrorWithStatus:subModel.apiMessage duration:DURATION_SHORT];
                }
                
            } failure:^(HttpException *e) {
                DebugLog(@"%@",e);
            }];
        }
    } failure:^(HttpException *e) {
        DebugLog(@"%@",e);
    }];
}

- (void)cosultButtonClick
{
    if(!QWGLOBALMANAGER.loginStatus) {
        LoginViewController *loginViewController = [[LoginViewController alloc] initWithNibName:@"LoginViewController" bundle:nil];
        UINavigationController *navgationController = [[QWBaseNavigationController alloc] initWithRootViewController:loginViewController];
        loginViewController.isPresentType = YES;
        [self presentViewController:navgationController animated:YES completion:NULL];
        return;
    }
    if(self.shouldPushNextWeChat) {
        [self.navigationController popViewControllerAnimated:NO];
    }else{
        ChatViewController *consultViewController = [[UIStoryboard storyboardWithName:@"ChatViewController" bundle:[NSBundle mainBundle]] instantiateViewControllerWithIdentifier:@"ChatViewController"];
        //        PTPWeChatMessageTableViewController *consultViewController=[[PTPWeChatMessageTableViewController alloc] init];
        consultViewController.sendConsultType = Enum_SendConsult_Common;
        consultViewController.branchId=self.storeModel.id;
        consultViewController.branchName = self.storeModel.shortName;
        [self.navigationController pushViewController:consultViewController animated:YES];
    }
}

#pragma mark - 跑马灯按钮点击触发函数
- (void)didSelectedButtonAtIndex:(NSInteger)index{
    BranchActivityVo *vo = self.activityList[index];
    
    if([vo.actityType intValue] == 1){
        
        MarketDetailViewController *marketDetailViewController = nil;
        marketDetailViewController = [[MarketDetailViewController alloc] initWithNibName:@"MarketDetailViewController" bundle:nil];
        NSMutableDictionary *infoDict = [NSMutableDictionary dictionary];
        infoDict[@"activityId"] = vo.activityId;
        infoDict[@"groupId"] = self.storeId;
        marketDetailViewController.infoDict = infoDict;
        marketDetailViewController.userType = 1;
        [self.navigationController pushViewController:marketDetailViewController animated:YES];
    }
    if([vo.actityType intValue] == 2){
        
        
        CouponPharmacyDeailViewController *couponPharmacy = [[CouponPharmacyDeailViewController alloc]initWithNibName:@"CouponPharmacyDeailViewController" bundle:nil];
        couponPharmacy.storeId = self.storeId;
        couponPharmacy.activityId = vo.activityId;
    [self.navigationController pushViewController:couponPharmacy animated:YES];
    }
}

#pragma mark - AlertViewDelegate
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    
    if(buttonIndex == 1){
        [[UIApplication sharedApplication] openURL:[NSURL URLWithString:[NSString stringWithFormat:@"tel://%@",self.storeModel.tel]]];
    }
}
#pragma mark 其他类型方法

- (NSString *)checkStringIsEmpty:(NSString *)str
{
    if (StrIsEmpty(str)) {
        return @"";
    }
    return str;
}

- (void)popVCAction:(id)sender{
    [super popVCAction:sender];
}

#pragma mark 
#pragma mark 跳转到首页代码块
- (void)setUpRightItem
{
//    UIBarButtonItem *fixed = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
//    fixed.width = -15;
//    
//    UIView *rightView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 60, 40)];
//    
//    //三个点button
//    UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];
//    button.frame = CGRectMake(8, 0, 50, 40);
//    [button setImage:[UIImage imageNamed:@"icon-unfold.PNG"] forState:UIControlStateNormal];
//    [button addTarget:self action:@selector(returnIndex) forControlEvents:UIControlEventTouchUpInside];
//    [rightView addSubview:button];
//    
//    //数字角标
//    self.numLabel = [[UILabel alloc] initWithFrame:CGRectMake(42, 5, 18, 18)];
//    self.numLabel.backgroundColor = [UIColor redColor];
//    self.numLabel.layer.cornerRadius = 9.0;
//    self.numLabel.textColor = [UIColor whiteColor];
//    self.numLabel.font = [UIFont systemFontOfSize:10];
//    self.numLabel.textAlignment = NSTextAlignmentCenter;
//    self.numLabel.layer.masksToBounds = YES;
//    self.numLabel.text = @"10";
//    self.numLabel.hidden = YES;
//    [rightView addSubview:self.numLabel];
//    
//    //小红点
//    self.redLabel = [[UILabel alloc] initWithFrame:CGRectMake(43, 10, 8, 8)];
//    self.redLabel.backgroundColor = [UIColor redColor];
//    self.redLabel.layer.cornerRadius = 4.0;
//    self.redLabel.layer.masksToBounds = YES;
//    self.redLabel.hidden = YES;
//    [rightView addSubview:self.redLabel];
//    
//    UIBarButtonItem *rightItem = [[UIBarButtonItem alloc] initWithCustomView:rightView];
//    self.navigationItem.rightBarButtonItems = @[fixed,rightItem];
//    
//    if (self.passNumber > 0)
//    {
//        //显示数字
//        self.numLabel.hidden = NO;
//        self.redLabel.hidden = YES;
//        self.numLabel.text = [NSString stringWithFormat:@"%d",self.passNumber];
//        
//    }else if (self.passNumber == 0)
//    {
//        //显示小红点
//        self.numLabel.hidden = YES;
//        self.redLabel.hidden = NO;
//        
//    }else if (self.passNumber < 0)
//    {
//        //全部隐藏
//        self.numLabel.hidden = YES;
//        self.redLabel.hidden = YES;
//    }
    
    UIView *yhxqBarItems = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 120, 55)];
    UIButton *reportButton = [[UIButton alloc] initWithFrame:CGRectMake(23, 0, 55, 55)];
    [reportButton setTitle:@"举报" forState:UIControlStateNormal];
    reportButton.titleLabel.font = [UIFont systemFontOfSize:16];
    [reportButton addTarget:self action:@selector(reportItemClick) forControlEvents:UIControlEventTouchDown];
    [yhxqBarItems addSubview:reportButton];
    
    
    UIView *rightView = [[UIView alloc] initWithFrame:CGRectMake(65, 0, 60, 55)];
    //三个点button
    UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];
    button.frame = CGRectMake(-5, 6, 50, 40);
    [button setImage:[UIImage imageNamed:@"icon-unfold.PNG"] forState:UIControlStateNormal];
    [button addTarget:self action:@selector(returnIndex) forControlEvents:UIControlEventTouchUpInside];
    [rightView addSubview:button];
    
    //数字角标
    self.numLabel = [[UILabel alloc] initWithFrame:CGRectMake(28, 9, 18, 18)];
    self.numLabel.backgroundColor = RGBHex(qwColor3);
    self.numLabel.layer.cornerRadius = 9.0;
    self.numLabel.textColor = [UIColor whiteColor];
    self.numLabel.font = [UIFont systemFontOfSize:11];
    self.numLabel.textAlignment = NSTextAlignmentCenter;
    self.numLabel.layer.masksToBounds = YES;
    self.numLabel.text = @"10";
    self.numLabel.hidden = YES;
    [rightView addSubview:self.numLabel];
    
    //小红点
    self.redLabel = [[UILabel alloc] initWithFrame:CGRectMake(29, 17, 8, 8)];
    self.redLabel.backgroundColor = RGBHex(qwColor3);
    self.redLabel.layer.cornerRadius = 4.0;
    self.redLabel.layer.masksToBounds = YES;
    self.redLabel.hidden = YES;
    [rightView addSubview:self.redLabel];
    [yhxqBarItems addSubview:rightView];
    
    UIBarButtonItem *fixed = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
    fixed.width = -20;
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc]initWithTitle:@"举报" style:UIBarButtonItemStylePlain target:self action:@selector(reportItemClick)];
    if (self.passNumber > 0)
    {
        //显示数字
        self.numLabel.hidden = NO;
        self.redLabel.hidden = YES;
        if (self.passNumber > 99) {
            self.passNumber = 99;
        }
        self.numLabel.text = [NSString stringWithFormat:@"%d",self.passNumber];
        
    }else if (self.passNumber == 0)
    {
        //显示小红点
        self.numLabel.hidden = YES;
        self.redLabel.hidden = NO;
        
    }else if (self.passNumber < 0)
    {
        //全部隐藏
        self.numLabel.hidden = YES;
        self.redLabel.hidden = YES;
    }

    
    
}
- (void)returnIndex
{
    self.indexView = [ReturnIndexView sharedManagerWithImage:@[@"ic_img_notice",@"icon home.PNG",@"icon_share_new"] title:@[@"消息",@"首页",@"分享"] passValue:self.passNumber];
    self.indexView.delegate = self;
    [self.indexView show];
}
- (void)RetunIndexView:(ReturnIndexView *)ReturnIndexView didSelectedIndex:(NSIndexPath *)indexPath
{
    [self.indexView hide];
    
    if (indexPath.row == 0)
    {
        if(!QWGLOBALMANAGER.loginStatus) {
            LoginViewController *loginViewController = [[LoginViewController alloc] initWithNibName:@"LoginViewController" bundle:nil];
            UINavigationController *navgationController = [[QWBaseNavigationController alloc] initWithRootViewController:loginViewController];
            loginViewController.isPresentType = YES;
            [self presentViewController:navgationController animated:YES completion:NULL];
            return;
        }
        
        MessageBoxListViewController *vcMsgBoxList = [[UIStoryboard storyboardWithName:@"MessageBoxListViewController" bundle:[NSBundle mainBundle]] instantiateViewControllerWithIdentifier:@"MessageBoxListViewController"];
        
        vcMsgBoxList.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vcMsgBoxList animated:YES];
        
    }else if (indexPath.row == 1){
        [self.navigationController popToRootViewControllerAnimated:YES];
        [self performSelector:@selector(delayPopToHome) withObject:nil afterDelay:0.01];
    }else if (indexPath.row == 2){
        ShareContentModel *modelShare = [[ShareContentModel alloc] init];
        modelShare.typeShare = ShareTypePharmacy;
        modelShare.shareID = self.storeModel.id;
        modelShare.title = self.storeModel.name;
        if (self.storeModel.brandImgUrl.length > 0) {
            modelShare.imgURL = self.storeModel.brandImgUrl;
        } else {
            modelShare.imgURL = self.storeModel.imgUrl;
        }
        modelShare.content = self.storeModel.intro;//[NSString stringWithFormat:@"我在问药客户端发现了%@，很不错噢！",self.storeModel.name];
        ShareSaveLogModel *modelR = [ShareSaveLogModel new];
        MapInfoModel *mapInfoModel = [QWUserDefault getObjectBy:APP_MAPINFOMODEL];
        if(mapInfoModel) {
            modelR.city = mapInfoModel.city;
            modelR.province = mapInfoModel.province;
        }else{
            modelR.city = @"苏州市";
            modelR.province = @"江苏省";
        }
        modelR.shareObj = @"3";
        modelR.shareObjId = self.storeModel.id;
        modelShare.modelSavelog = modelR;
        [self popUpShareView:modelShare];
    }
}

- (void)delayPopToHome
{
    [QWGLOBALMANAGER.tabBar setSelectedIndex:0];
}

- (void)reportItemClick
{
    ReportDrugStoreViewController *reportDrugStoreViewController = [[ReportDrugStoreViewController alloc] init];
    
    reportDrugStoreViewController.storeID = self.storeId;
    [self.navigationController pushViewController:reportDrugStoreViewController animated:YES];
}

- (void)getNotifType:(Enum_Notification_Type)type data:(id)data target:(id)obj{
    if (NotiWhetherHaveNewMessage == type) {
        
        NSString *str = data;
        self.passNumber = [str integerValue];
        self.indexView.passValue = self.passNumber;
        [self.indexView.tableView reloadData];
        if (self.passNumber > 0)
        {
            //显示数字
            self.numLabel.hidden = NO;
            self.redLabel.hidden = YES;
            if (self.passNumber > 99) {
                self.passNumber = 99;
            }
            self.numLabel.text = [NSString stringWithFormat:@"%d",self.passNumber];
            
        }else if (self.passNumber == 0)
        {
            //显示小红点
            self.numLabel.hidden = YES;
            self.redLabel.hidden = NO;
            
        }else if (self.passNumber < 0)
        {
            //全部隐藏
            self.numLabel.hidden = YES;
            self.redLabel.hidden = YES;
        }
    }
}

- (IBAction)bgViewButtonClick:(UIButton *)sender {
    [self loadAllDataAsynchronous];
}
@end
